name: Build

on:
  push:
    branches:
    - "master"
    - "min/build-image"
  workflow_call:
    secrets:
      # Secrets used to build
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
      GH_BOT_DEPLOY_KEY:
        required: true

jobs:
  hash:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.hash.outputs.short }}
    steps:
      - id: hash
        uses: pr-mpt/actions-commit-hash@v2
        with:
          # NOTE: since this workflow is only triggered by `push` event
          # github.sha have correct commit sha
          commit: ${{ github.sha }}
  build:
    needs: hash
    strategy:
      matrix:
        include:
          - tag: libks-libs10-${{ needs.hash.outputs.HASH }}
            baseimage: "signalwire/freeswitch-base:debian-10"
          - tag: libks-libs11-${{ needs.hash.outputs.HASH }}
            baseimage: "signalwire/freeswitch-base:debian-11"     
    name: "build libks"
    uses: signalwire/actions-template/.github/workflows/ci-build.yml@main
    with:
      CONTAINER_SCAN: true
      CONTAINER_TEST: false
      PROJECT_NAME: "freeswitch-libs"
      FILE: ./Dockerfile
      PUSH: true
      RUNNER: ubuntu-latest
      TAG: ${{ matrix.tag }}
      BUILD_ARGS: |
        BASEIMAGE=${{ matrix.baseimage }}
    secrets: inherit
